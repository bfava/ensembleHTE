% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/compare_restricted.R
\name{gates_compare}
\alias{gates_compare}
\title{Compare GATES: Unrestricted vs Restricted Ranking}
\usage{
gates_compare(
  ensemble_fit,
  strata,
  n_groups = 3,
  outcome = NULL,
  treatment = NULL,
  prop_score = NULL,
  controls = NULL,
  subset = NULL
)
}
\arguments{
\item{ensemble_fit}{An object of class \code{ensemble_hte_fit} from 
\code{ensemble_hte()} or \code{ensemble_pred_fit} from \code{ensemble_pred()}.}

\item{strata}{The stratification variable defining groups for restricted ranking:
\itemize{
  \item Character string: column name in the \code{data} used in the ensemble function
  \item Numeric/factor vector: strata indicator (must have same length as data)
}}

\item{n_groups}{Number of groups to divide the sample into (default: 3)}

\item{outcome}{Either:
\itemize{
  \item NULL (default): uses the same outcome as in the ensemble function
  \item Character string: column name in the \code{data} used in the ensemble function
  \item Numeric vector: custom outcome variable (must have appropriate length)
}}

\item{treatment}{For \code{ensemble_pred_fit} only. The treatment variable:
\itemize{
  \item Character string: column name in the \code{data} used in \code{ensemble_pred()}
  \item Numeric vector: binary treatment variable (must have same length as data)
}
Ignored for \code{ensemble_hte_fit} (uses the treatment from the fit).}

\item{prop_score}{For \code{ensemble_pred_fit} only. Propensity score:
\itemize{
  \item NULL (default): estimated as mean of treatment variable
  \item Numeric value: constant propensity score for all observations
  \item Numeric vector: observation-specific propensity scores
}
For \code{ensemble_hte_fit}, uses the propensity score from the fit.}

\item{controls}{Optional character vector of control variable names from \code{data}
to include as covariates in the GATES regression.}

\item{subset}{Which observations to use for the GATES comparison. Options:
\itemize{
  \item NULL (default): uses all observations (or training obs for \code{ensemble_pred_fit}
    when using the default outcome with subset training)
  \item \code{"train"}: uses only training observations (for \code{ensemble_pred_fit} only)
  \item \code{"all"}: explicitly uses all observations
  \item Logical vector: TRUE/FALSE for each observation (must have same length as data)
  \item Integer vector: indices of observations to include (1-indexed)
}
This allows evaluating GATES comparison on a subset of observations.}
}
\value{
An object of class \code{gates_compare_results} containing:
\itemize{
  \item unrestricted: \code{gates_results} object for unrestricted strategy
  \item restricted: \code{gates_results} object for restricted strategy
  \item difference: data.table with the difference (unrestricted - restricted)
    for each group, with properly computed standard errors
  \item top_bottom_diff: data.table with difference in top-bottom estimates
  \item all_diff: data.table with difference in weighted average (all) estimates
  \item top_all_diff: data.table with difference in top-all estimates
  \item strata_var: name of the stratification variable
  \item strata_levels: unique levels of the stratification variable
  \item n_groups: number of groups used
  \item outcome: the outcome variable used
  \item targeted_outcome: the outcome used for prediction
  \item fit_type: "hte" or "pred" depending on input
  \item n_used: number of observations used
  \item M: number of repetitions
  \item call: the function call
}
}
\description{
Compares Group Average Treatment Effects (GATES) between an unrestricted strategy 
(ranking predictions across the full sample) and a restricted strategy (ranking
predictions within strata of a stratification variable).

This function implements the analysis from Fava (2025) to test whether
ranking by predicted treatment effects within subgroups (e.g., income quintiles,
education levels) yields different treatment effect estimates than global ranking.

The key statistical challenge is computing correct standard errors for the
difference between the two strategies, since they use the same data. This
is handled by computing the cross-covariance between regression estimates.
}
\examples{
\dontrun{
# Fit ensemble
fit <- ensemble_hte(Y ~ X1 + X2, data = mydata, treatment = "D")

# Compare unrestricted vs restricted by income quintile
comparison <- gates_compare(fit, strata = "income_quintile", n_groups = 5)
print(comparison)
}

}
\references{
Fava, B. (2025). Training and Testing with Multiple Splits: A Central Limit
Theorem for Split-Sample Estimators. \emph{arXiv preprint arXiv:2511.04957}.
}
